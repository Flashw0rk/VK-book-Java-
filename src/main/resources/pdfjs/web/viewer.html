<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Просмотр PDF с навигацией и маркерами</title>
    <style>
        body {
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          background: #404040;
          height: 100vh;
        }

        #container {
          width: 100%;
          height: 100vh;
          position: relative;
          overflow: auto;
          background: #525659;
        }

        #toolbar {
          display: flex;
          gap: 10px;
          padding: 8px;
          background: #333;
          color: white;
          align-items: center;
        }

        #toolbar button {
          background: #555;
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 3px;
          cursor: pointer;
        }

        #toolbar button:hover {
          background: #666;
        }

        #toolbar input {
          width: 50px;
          text-align: center;
        }

        #pdfContainer {
          position: relative;
          margin: 20px auto;
          background: white;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .pdf-page {
          position: relative;
          margin: 10px auto;
          background: white;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .armature-marker {
          position: absolute;
          border: 2px solid red;
          background-color: rgba(255, 0, 0, 0.2);
          pointer-events: none;
          box-sizing: border-box;
          border-radius: 4px;
          z-index: 10;
        }

        .armature-label {
          position: absolute;
          top: -24px;
          left: 0;
          background-color: red;
          color: white;
          padding: 2px 5px;
          border-radius: 3px;
          font-size: 12px;
          white-space: nowrap;
        }

        #loading {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: white;
          font-size: 24px;
          text-align: center;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
<div id="toolbar">
    <button id="prev">◀</button>
    <button id="next">▶</button>
    <span>Страница: <span id="page_num">1</span> / <span id="page_count">?</span></span>
    <input type="number" id="page_input" min="1" value="1">
    <button id="go_to">Перейти</button>
    <span>Масштаб:</span>
    <button id="zoom_in">+</button>
    <button id="zoom_out">-</button>
</div>

<div id="container">
    <div id="loading">Загрузка PDF...</div>
    <div id="pdfContainer"></div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let pdfDoc = null;
    let currentPage = 1;
    let scale = 1.0;
    const container = document.getElementById('pdfContainer');
    const loadingEl = document.getElementById('loading');
    const scrollContainer = document.getElementById('container');
    let currentArmatureCoords = null; // Новая переменная для хранения координат

    function logToJava(msg) {
      if (window.javaApp?.log) window.javaApp.log(msg);
    }

    function errorToJava(msg) {
      if (window.javaApp?.error) window.javaApp.error(msg);
    }

    function notifyJavaLoaded() {
        if (window.javaApp?.pdfLoaded) {
            window.javaApp.pdfLoaded();
        }
    }

    async function renderPage(num, coordsToCenter = null) {
      if (!pdfDoc) {
          notifyJavaLoaded();
          return;
      }
      loadingEl.style.display = 'block';

      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.className = 'pdf-page';

        container.innerHTML = '';
        container.appendChild(canvas);

        await page.render({ canvasContext: context, viewport }).promise;

        document.getElementById('page_num').textContent = num;
        document.getElementById('page_input').value = num;
        document.getElementById('page_count').textContent = pdfDoc.numPages;

        if (coordsToCenter) {
            requestAnimationFrame(() => {
                const scrollX = (coordsToCenter.x * scale) - (scrollContainer.clientWidth / 2);
                const scrollY = (coordsToCenter.y * scale) - (scrollContainer.clientHeight / 2);
                scrollContainer.scrollLeft = scrollX;
                scrollContainer.scrollTop = scrollY;
                // addArmatureMarker(coordsToCenter.page, coordsToCenter.x, coordsToCenter.y, coordsToCenter.width || 40, coordsToCenter.height || 30, coordsToCenter.label);
                logToJava(`Scrolled to x=${scrollX}, y=${scrollY}, scale=${scale}`);
            });
            currentArmatureCoords = coordsToCenter; // Сохраняем координаты
        }

        // Перерисовываем маркер, если он есть для текущей страницы
        if (currentArmatureCoords && currentArmatureCoords.page === num) {
             addArmatureMarker(currentArmatureCoords.page, currentArmatureCoords.x, currentArmatureCoords.y, currentArmatureCoords.width || 40, currentArmatureCoords.height || 30, currentArmatureCoords.label);
        }

      } catch (e) {
        errorToJava(`Ошибка рендеринга страницы: ${e.message}`);
      } finally {
        loadingEl.style.display = 'none';
        notifyJavaLoaded();
      }
    }

    // Метод для загрузки PDF из Base64 без центрирования
    window.loadPdfFromBase64 = async function (base64) {
        logToJava('Вызвана loadPdfFromBase64');
        if (!base64) {
            errorToJava('Пустая строка Base64');
            notifyJavaLoaded();
            return;
        }
        currentArmatureCoords = null; // Сбрасываем маркер при загрузке нового PDF

        loadingEl.style.display = 'block';

        try {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            pdfDoc = await pdfjsLib.getDocument({ data: bytes.buffer }).promise;
            currentPage = 1;
            scale = 1.0;
            await renderPage(currentPage);
        } catch (e) {
            loadingEl.textContent = `Ошибка: ${e.message}`;
            errorToJava(`Ошибка загрузки PDF: ${e.message}`);
            loadingEl.style.display = 'none';
        } finally {
            notifyJavaLoaded();
        }
    };

    // Метод для загрузки, центрирования и добавления маркера
    window.loadAndCenterPdf = async function(base64, centerX, centerY, targetZoom, pageNumber, label) {
        logToJava('Вызвана loadAndCenterPdf');
        if (!base64) {
            errorToJava('Пустая строка Base64');
            notifyJavaLoaded();
            return;
        }

        loadingEl.style.display = 'block';

        try {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            pdfDoc = await pdfjsLib.getDocument({ data: bytes.buffer }).promise;
            currentPage = pageNumber || 1;
            scale = targetZoom || 1.0;

            const coords = {
                x: centerX,
                y: centerY,
                page: pageNumber,
                label: label,
                width: 40,  // Эти значения можно сделать динамическими
                height: 30 // если они передаются из Java
            };
            currentArmatureCoords = coords;

            await renderPage(currentPage, coords);
        } catch (e) {
            loadingEl.textContent = `Ошибка: ${e.message}`;
            errorToJava(`Ошибка loadAndCenterPdf: ${e.message}`);
            loadingEl.style.display = 'none';
        } finally {
            notifyJavaLoaded();
        }
    };

    // Навигация
    document.getElementById('prev').onclick = async () => {
      if (currentPage > 1) {
        currentPage--;
        await renderPage(currentPage);
      }
    };

    document.getElementById('next').onclick = async () => {
      if (currentPage < pdfDoc.numPages) {
        currentPage++;
        await renderPage(currentPage);
      }
    };

    document.getElementById('go_to').onclick = async () => {
      const val = parseInt(document.getElementById('page_input').value);
      if (val >= 1 && val <= pdfDoc.numPages) {
        currentPage = val;
        await renderPage(currentPage);
      }
    };

    document.getElementById('zoom_in').onclick = async () => {
      scale += 0.25;
      await renderPage(currentPage);
    };

    document.getElementById('zoom_out').onclick = async () => {
      if (scale > 0.25) {
        scale -= 0.25;
        await renderPage(currentPage);
      }
    };

    function addArmatureMarker(page, x, y, width, height, label) {
      if (!pdfDoc || currentPage !== page) {
        logToJava(`Попытка добавить маркер на другую страницу: ${page}. Текущая: ${currentPage}`);
        return;
      }

      // Удаляем старые маркеры, чтобы не было дубликатов
      document.querySelectorAll('.armature-marker').forEach(marker => marker.remove());

      const canvas = container.querySelector('.pdf-page');
      if (!canvas) {
        errorToJava('Canvas не найден для страницы.');
        return;
      }

      const marker = document.createElement('div');
      marker.className = 'armature-marker';

      marker.style.left = `${x * scale}px`;
      marker.style.top = `${y * scale}px`;
      marker.style.width = `${width * scale}px`;
      marker.style.height = `${height * scale}px`;

      const labelEl = document.createElement('div');
      labelEl.className = 'armature-label';
      labelEl.textContent = label;
      marker.appendChild(labelEl);

      canvas.parentElement.appendChild(marker);
    }

    // Перемещение при зажатом колесике
    let isMiddleMouseDown = false;
    let lastX = 0;
    let lastY = 0;

    scrollContainer.addEventListener("mousedown", (e) => {
      if (e.button === 1) {
        isMiddleMouseDown = true;
        lastX = e.clientX;
        lastY = e.clientY;
        e.preventDefault();
      }
    });

    document.addEventListener("mouseup", (e) => {
      if (e.button === 1) {
        isMiddleMouseDown = false;
      }
    });

    document.addEventListener("mousemove", (e) => {
      if (!isMiddleMouseDown) return;

      scrollContainer.scrollLeft -= (e.clientX - lastX);
      scrollContainer.scrollTop -= (e.clientY - lastY);
      lastX = e.clientX;
      lastY = e.clientY;
    });
</script>
</body>
</html>